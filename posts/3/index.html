
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kevin Coleman</title>
  <meta name="author" content="Kevin Coleman">

  
  <meta name="description" content="Sometimes you may need to setup custom environments beyond the standard test, development, and production that rails comes with. If you would like to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.kcoleman.me/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Kevin Coleman" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-48081941-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Kevin Coleman</a></h1>
  
    <h2>I am a software engineer at Spark Start with interests in start ups, web apps, and wearables.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/KevinColemanInc" rel="subscribe-github" title="@KevinColemanInc on GitHub"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://plus.google.com/+KevinColemanInc" rel="publisher" title="Google+ Profile"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 23.03264,55.19021 C 32.01805,55.457578 38.046082,46.137447 36.495958,34.370183 34.943794,22.603939 26.398215,13.161349 17.411784,12.89296 8.4253533,12.625592 2.3973217,21.630392 3.9494863,33.400718 5.5006303,45.164921 14.043148,54.921821 23.03264,55.19021 z M 99.99898,24.999027 100,0 -0.00797206,0 0.0052943,16.202408 C 5.7047282,11.184661 13.611481,6.9914696 21.771315,6.9914696 c 8.721103,0 34.888495,0 34.888495,0 l -7.807765,6.6035874 -11.062106,0 c 7.33732,2.81349 11.246815,11.3407 11.246815,20.090377 0,7.348545 -4.082979,13.667416 -9.852826,18.161652 -5.629021,4.385043 -6.696453,6.220904 -6.696453,9.948752 0,3.180866 6.030073,8.594563 9.183386,10.81923 9.217061,6.498477 12.199952,12.530591 12.199952,22.603843 0,1.604209 -0.198996,3.206378 -0.591884,4.780993 L 100,100 c 0,0 0,-46.594917 0,-68.751495 l -18.750474,0 0,18.750475 -6.250499,0 0,-18.750475 -18.750474,0 0,-6.250498 18.750474,0 0,-18.7494538 6.250499,0 0,18.7494538 18.750474,0 z M 18.147557,74.798916 c 2.111393,0 4.04522,-0.05817 6.048441,-0.05817 -2.651232,-2.571634 -4.749358,-5.722905 -4.749358,-9.606889 0,-2.305285 0.738834,-4.52485 1.77157,-6.496436 -1.053145,0.0745 -2.127721,0.09695 -3.234952,0.09695 -7.261803,0 -13.4286215,-2.351208 -17.99020957,-6.236212 l 0,6.56685 0.00102048,19.70055 C 5.2128523,76.28781 11.409265,74.798916 18.147557,74.798916 z M 44.474145,93.051391 C 43.002599,87.308076 37.788918,84.46091 30.518951,79.420713 c -2.644088,-0.85313 -5.556565,-1.35521 -8.681304,-1.387866 -8.752739,-0.09389 -17.2452523,3.525266 -21.84561906,8.743028 l 0,13.224125 44.64641606,-0.0011 c 0,0 0.263286,-2.21038 0.263286,-3.362512 -10e-4,-1.222547 -0.151032,-2.419581 -0.427585,-3.58498 z"></path></svg></a></li>
</ul>
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="q" value="site:www.kcoleman.me" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/coleman-laws">Coleman Laws</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/15/custom-environements-with-rails-4/">Custom Environments With Rails 4</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-15T16:41:53+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:41 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you may need to setup custom environments beyond the standard <code>test</code>, <code>development</code>, and <code>production</code> that rails comes with.  If you would like to have your staging server configured a little big differently than test and production (maybe higher logging levels for example), then you would need to create another environment for these configurations called <code>staging</code>.</p>

<h2>Changes, Additions and Edits</h2>

<h3>Gemfile</h3>

<p>In your <code>Gemfile</code>, you should add your new environment to the necessary groups.  If your environment is similar to <code>production</code>, you should add <code>staging</code> next to everywhere you see the <code>production</code> group lie below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:staging</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;log4r&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Update config/database.yml</h3>

<p>You should create a new environment in your database.yml file.  This will look something like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="nl">&amp;default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">staging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">w2w-staging</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Environment Config</h3>

<p>In <code>config/environments/</code>, you should add <code>staging.rb</code>.  To make things easy, copy an existing environment that is most similar to the new one you are creating and make the adjustments you need from there.</p>

<h3>Update Secrets.yml</h3>

<p>If you are running rails 4.1, you will also need to update your <code>secrets.yml</code> file to handle new the new environment</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">staging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secrets_are_secretive_SALFJASFLKSAJFLSAFJOWERULSADFJLKSAFJD</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Misc</h3>

<p>Do a quick find on your project directory for any environment specific code being run.  Look for things like <code>Rails.env.</code> and add your new environment to these conditionals like below</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span> <span class="o">||</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="o">||</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">staging?</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/30/nodejs-chat-guide/">NodeJS Chat Guide</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-30T18:40:07+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:40 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>How I built the chat application for my blog.</h2>

<p>I have been chatting on wizpert offering technical support for questions and I was inspired to add a chatting aspect to my blog.  Feel free to hit me up on any Javascript, Ruby on Rails, or general programming questions.</p>

<h2>Installing NodeJS v0.10.26 on OSX Maverick 10.9</h2>

<p>I recommend installing this application with homebrew, so you can easily update it as you need to.</p>

<figure class='code'><figcaption><span>install nodejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">brew update</span>
</span><span class='line'><span class="go">brew doctor</span>
</span><span class='line'><span class="go">brew install node</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a folder called <code>Chat</code> and create a file in that called <code>main.js</code></p>

<figure class='code'><figcaption><span>create a git repo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">git init</span>
</span><span class='line'><span class="go">git add .</span>
</span><span class='line'><span class="go">git commit -m &quot;first!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the NodeJS chat server</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">xmpp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-xmpp&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">cl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span> <span class="nx">jid</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">jid</span><span class="p">,</span>  <span class="nx">password</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">password</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)()</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">admins</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">adminXMPP</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Welcome to the chat&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="s2">&quot;isAdminOnline&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Admin</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;admin_signin&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;register admin&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">admins</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">users</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]].</span><span class="nx">admin_connected</span> <span class="o">=</span> <span class="nx">socket</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;admin_to_server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">users</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;socket_id&quot;</span><span class="p">]].</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Kevin&quot;</span> <span class="p">});</span>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Kevin&quot;</span> <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Client</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message_to_server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">socket</span><span class="o">:</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nx">admin_connected</span><span class="o">:</span> <span class="kc">null</span> <span class="p">};</span>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">admin_connected</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">stanza</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Element</span><span class="p">(</span>
</span><span class='line'>            <span class="s1">&#39;message&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;chat&#39;</span> <span class="p">}</span>
</span><span class='line'>          <span class="p">).</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; says &quot;</span> <span class="o">+</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; to talk with them click here: http://ss-chat-p.herokuapp.com/admin#&quot;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">cl</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">stanza</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">admin_connected</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;stanza&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stanza</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;presence&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;unavailable&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">adminXMPP</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">adminXMPP</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">set_status_message</span><span class="p">(</span><span class="s2">&quot;SparkBot is ready&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Connected as &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">domain</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">resource</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">set_status_message</span><span class="p">(</span><span class="nx">status_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="kd">var</span> <span class="nx">presence_elem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;presence&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">})</span>
</span><span class='line'>                               <span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;chat&#39;</span><span class="p">).</span><span class="nx">up</span><span class="p">()</span>
</span><span class='line'>                               <span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="nx">status_message</span><span class="p">);</span>
</span><span class='line'>   <span class="nx">cl</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">presence_elem</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I create all of the singleton variables at the top of the nodejs file. <code>xmpp</code> is used for connecting to Google Talk.  <code>app</code>, <code>server</code>, and <code>io</code> are used to host the server and talk with the client via sockets.io.</p>

<p>I need to keep track of what <code>admins</code> are connected and what <code>users</code> are connected.  While there will only be one admin account, they can be logged into multiple locations.  For users, I need to keep track of their socket and their names to send to the client.  These will both be hash arrays keyed on their <code>socket.id</code>.</p>

<p><code>server.listen(process.env.PORT || 3000);</code> tells the server to listen to the hosting port.  Heroku wants to set its own report, so you must try to environment report before you use the development port (3000).</p>

<p>Once a socket has connected, we send them a welcome message via chat.  This also contains where or not the admin is available to talk.</p>

<p>When an admin connects, we add them to the registered admins list and set the admin socket on the users hash to the admin socket so when a client messages, we will know which admin socket to send it to.  Each socket represents its own chat session with a client.</p>

<p>When the server gets a message from the admin, it runs the <code>admin_to_server</code> event and it transmits the message to the client and back to the admin.  This way both users can see the message.</p>

<p>Clients trigger the <code>message_to_server</code> action when they want to send a chat message to the admin.  If we haven&rsquo;t seen this user before, we add them to the users hash and spit their message back to them.  If the admin hasn&rsquo;t connected yet, it sends a xmpp message to the admin&rsquo;s gmail account notifying them that they someone is interested in talking with them.  The URL in the message contains the user&rsquo;s socket so the server will know what admin socket is intended for what user.</p>

<p>If the admin has connected, then it transmits it to their socket.</p>

<p>We need to keep track of when the admin is available for contact.  When the server starts, it initiates an xmpp connection and starts getting notifications about contact statuses.  If a user changes status or logs in, we add the admin to the <code>adminXMPP</code> so we know who to contact when a client arrives.  If they log out, they are removed from <code>adminXMPP</code>.  If the length of the array is 0, no admins are available and we report that to clients.</p>

<p>The status message is set to &lsquo;SparkBot is ready&rsquo; when the xmpp client connects and it displays their user information in the logs.</p>

<p>If there are any errors with the xmpp client, they are displayed in the logs and the process is killed.</p>

<p>The <code>set_status_method</code> function wraps the xmpp request to set the status message for the Google Talk client.sdfsdf</p>

<h2>Creating the Client view</h2>

<p>This blog is hosted on Github Pages and talks with my server on a different subdomain (chat.kcoleman.me).  I loved the style of Google Talk&rsquo;s chat window with the speech boxes pointing to a profile pic.  Since I don&rsquo;t have a profile pic to use, I replaced that with a name.  You can style this code to your hearts content, but the Javascript I used looks like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="kd">var</span> <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;ss-chat-p.herokuapp.com&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;div class=&#39;avatar&#39;&gt;&lt;b&gt;&lt;span&gt;&quot;</span> <span class="o">+</span>
</span><span class='line'>        <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&lt;/b&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&lt;div class=&#39;messages&#39;&gt;&quot;</span><span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;li class=&#39;self&#39;&gt;&quot;</span> <span class="o">+</span>  <span class="nx">msgHTML</span> <span class="o">+</span> <span class="s2">&quot;&lt;/li&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;li class=&#39;other&#39;&gt;&quot;</span> <span class="o">+</span>  <span class="nx">msgHTML</span> <span class="o">+</span> <span class="s2">&quot;&lt;/li&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;discussion&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;discussion&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="nx">msgHTML</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#discussion&quot;</span><span class="p">).</span><span class="nx">prop</span><span class="p">({</span> <span class="nx">scrollTop</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#discussion&quot;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s2">&quot;scrollHeight&quot;</span><span class="p">)</span> <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_server&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span> <span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">name</span> <span class="p">});</span>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It first tries to connect to the server.  When it receives a message to display, the <code>message_to_client</code> action is triggered.  Here I format the HTML as a string based off of the data payload.  Then it adds into the discussion window.</p>

<p>When a user clicks the submit button, I get the values of the input name and message box and send them to the server as &ldquo;message_to_server&rdquo; and then clear the box for the next message.</p>

<p>Because this uses Sockets.io, we need to include their library in the client as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://ss-chat-p.herokuapp.com/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Admin View</h2>

<p>This code should look pretty similar to the client, except we need the admin to register right when it connects so we can start sending him the client messages.</p>

<figure class='code'><figcaption><span>admin page</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;chat.kcoleman.me&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">register</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">target_user</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">socketio</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;chatlog&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;hr/&gt;&lt;b&gt;&quot;</span> <span class="o">+</span>
</span><span class='line'>    <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/b&gt;: &quot;</span><span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;chatlog&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">register</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;admin_signin&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">target_user</span> <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;admin_to_server&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span> <span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">socket_id</span> <span class="o">:</span> <span class="nx">target_user</span><span class="p">});</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the client connects, it immediately tries to register itself so that the system will know it is available to receive messages.</p>

<h2>In the Future</h2>

<p>I want to be able to retrieve the client&rsquo;s user agent so if there are any browser compatibility errors, I can easily see what browser they have.  If there is a strong need, I may look at implementing a co-browsing solution so I will be able to follow along with them as they navigate my website.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/16/rapid-fire-ticket-purchasing-and-the-extendable-web/">Rapid Ticket Purchasing and the Extendable Web</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-16T18:30:31+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:30 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Backstory</h2>

<p>Last month, I was interested in attending a camping event with my girlfriend.  The event organizers release the tickets in two phases with each phase releasing 1000 tickets.  Despite my wicked fast internet connection at Panera Bread, I was unable to purchase the released tickets before they sold out.</p>

<p>In an effort to learn new things, I put my hand towards creating an auto-buy Chrome extension to significantly increase my chances of a ticket purchase.  I also intended to open source the project so anyone would be able to contribute.  Enter <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">rapid_fire_tickets</a>.</p>

<h2>Building the Chrome Extension</h2>

<p>If you get lost, feel free to download the source code for this extension at <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">https://github.com/KevinColemanInc/rapid_fire_tickets</a></p>

<p>Chrome extensions allow you to inject javascript on the page for DOM manipulation.  Firstly, you should create a directory and with our project name as the title.</p>

<p>Now create a <code>manifest.json</code> file.  This file contains all of the high level descriptive information about your project like the name, description, what permissions it wants, what version it is, etc.</p>

<figure class='code'><figcaption><span>manifest.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;manifest_version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Rapid fire tickets for Transformus&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;This extension automatically keeps trying to buy tickets for Transformus.&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;content_scripts&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://www.brownpapertickets.com/event/614931*&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;js&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;jquery.js&quot;</span><span class="p">,</span> <span class="s2">&quot;home.js&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;run_at&quot;</span><span class="p">:</span> <span class="s2">&quot;document_start&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://www.brownpapertickets.com/viewcart.html&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;js&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;jquery.js&quot;</span><span class="p">,</span> <span class="s2">&quot;checkout.js&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;run_at&quot;</span><span class="p">:</span> <span class="s2">&quot;document_end&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first part is very self explanatory, but the <code>content_scripts</code> attribute is much more interesting.  Here you can request Chrome to run javascript files if the URL pattern matches the string provided.  Since I know that the ticketing websites URL is such, I included that in the matches string.  The asterisk at the end of the string protects me against any strange URL parameters that might present themselves.</p>

<p>The <code>js</code> attribute tells Chrome to run the included js files when that URL is hit.  I included <code>jQuery</code> in this extension so make life easier.  Then I put my custom js file that will be used to refresh the page and select tickets.</p>

<p>The <code>run_at</code> attribute requests that chrome run the JS at document start.  I did this because I wanted the JS to run before all of the attributes to load so it will behave faster.</p>

<p>Next I will go download <code>jQuery</code> and save it into this folder.  Be sure to name the file the same as how you named it the manifest file.</p>

<p>Next I will create my home.js file.  The idea here is to have it refresh the page until the we see the drop down for ticket selection.  Once that appears we need to set that to a value of 2 and click the submit button on the form.</p>

<h2>Testing</h2>

<p>From that link, we have no idea what the HTML looks and thus dont know how to sculpt the jQuery selectors to target the correct form elements.  I created a test event and modeled it to behave exactly like the tfus event will when the tickets are released.  This way I can test my software before aiming it at the first event.</p>

<h2>Refresh and check to see if tickets are available</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">//buy tickets</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span> <span class="c1">//reload</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>On my test page I noticed that the orange submit button appears on the page when tickets are available.  For this tool, I am going to look for all orange buttons on the page.  If one appears, then tickets are ready to be purchased.  If they are not, then we need to reload the page to check again.</p>

<h2>Select the number of tickets you want</h2>

<p>Now that I can detect when the tickets are available.  I am need to select the drop down and select the number of tickets.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bpt_date_prices_1017125 .bpt_widget_price_table tr:nth-child(4) select&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using Chrome development tools, I found that this selector worked nicely at accomplishing that.  The id of the first element changes event to event, so if I wish to use this against other events, this will need to change.</p>

<p>Putting it all together we get this:</p>

<figure class='code'><figcaption><span>home.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bpt_date_prices_1017125 .bpt_widget_price_table tr:nth-child(4) select&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>A super simple auto add to cart ticket file.</p>

<h2>One step further</h2>

<p>After the tickets have been added to cart, it displays a page asking if you would like to check out now.  Under most circumstances, this scenario is yes.  To speed up the ticket purchasing process, I added another script to auto-click this button.  We can just skip that page and go to directly to the credit card input page.</p>

<p>The script that handles this is similar to the last one and looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">parent</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="s1">&#39;https://www.brownpapertickets.com/checkout.html&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rather than locating that button and click it.  I recognized that button is just a link to the checkout page so I ask the browser to relocate to this page.  If there are an cosmetic changes to this page and they change how the page is displayed, it may break any selectors I use on finding that button.  This solution is much more elegant and simple.</p>

<h2>Installation</h2>

<ol>
<li>In Chrome to <a href="chrome://extensions/">chrome://extensions/</a> and click &ldquo;Load unpacked extensions&rdquo;</li>
<li>Navigate to the location of the folder you created with the manifest.</li>
<li>Sign into your <a href="http://www.brownpapertickets.com">http://www.brownpapertickets.com</a> account</li>
<li>Open a bunch of tabs in chrome and navigate them all to: <a href="http://www.brownpapertickets.com/event/614931">http://www.brownpapertickets.com/event/614931</a></li>
</ol>


<h3>Alternative installation (using my source code on <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">github</a>).</h3>

<ol>
<li>Download the <a href="https://github.com/KevinColemanInc/rapid_fire_tickets/archive/master.zip">zip file</a></li>
<li>Unzip it</li>
<li>In Chrome to <a href="chrome://extensions/">chrome://extensions/</a> and click &ldquo;Load unpacked extensions&rdquo;</li>
<li>Navigate to the unziped location of the file.</li>
<li>Sign into your <a href="http://www.brownpapertickets.com">http://www.brownpapertickets.com</a> account</li>
<li>Open a bunch of tabs in chrome and navigate them all to: <a href="http://www.brownpapertickets.com/event/614931">http://www.brownpapertickets.com/event/614931</a></li>
</ol>


<h2>Buying more than two tickets</h2>

<p>This extension will only purchase two tickets per installation of Chrome.  If you are interested in using this to accumulate more, then here are my recommendations.</p>

<p>In <a href="chrome://extensions/">chrome://extensions/</a>, scroll down to the rapid_fire_tickets and select &ldquo;Allow in incognito mode.&rdquo;  Incognito mode allows you to login to Brown Paper Tickets from another account (thus giving you an additional 2 more tickets).</p>

<p>Now press <code>Ctrl+Shift+N</code> to open a new incognito window, login to a different account and navigate to the event page.  Now you buy 4 tickets!</p>

<p>Next, we should install a couple copies of Chrome.  Chrome only allows one version to be installed on a computer at a given time.  So lets grab other builds!  Go to <a href="http://www.chromium.org/getting-involved/dev-channel">http://www.chromium.org/getting-involved/dev-channel</a> and download and install their canary release.  This version runs seperately from what you have on your computer, because it can be less stable.</p>

<p>Configure the extension like you did before and now you have 8 tickets you can purchase!  Remember, only two tickets can be purchased at once per account so be sure to use different accounts.</p>

<h3>Quick tip: One gmail for multiple accounts</h3>

<p>If you use gmail, you can use their wild card feature to have different emails that point to your email.  For example my email is <a href="&#109;&#x61;&#105;&#108;&#x74;&#x6f;&#58;&#x63;&#x2e;&#112;&#114;&#x6f;&#x67;&#x72;&#x61;&#x6d;&#101;&#114;&#64;&#x67;&#109;&#x61;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;&#x2e;">&#99;&#x2e;&#x70;&#x72;&#x6f;&#x67;&#x72;&#x61;&#109;&#101;&#114;&#64;&#103;&#109;&#x61;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;&#x2e;</a>  I can create a different brown paper tickets account with this email <a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#x6f;&#58;&#x63;&#46;&#112;&#114;&#x6f;&#103;&#114;&#x61;&#x6d;&#x65;&#x72;&#x2b;&#x62;&#x70;&#x74;&#x40;&#x67;&#x6d;&#97;&#105;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">&#99;&#46;&#112;&#x72;&#x6f;&#103;&#114;&#x61;&#x6d;&#x65;&#x72;&#x2b;&#x62;&#112;&#116;&#64;&#x67;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#111;&#x6d;</a> and all of the emails going to that new email go to my main inbox.  This way I don&rsquo;t have to keep creating emails to make new accounts.  Anything between the + and the @ symbols are ignored in gmail only.</p>

<h3>Lets scale this further (8 to infinite and beyond!)</h3>

<p>We can apply this technique to multiple computers.  Each computer earns you 8 tickets. So if you are like myself that has a laptop and a desktop and a gf&rsquo;s computer, then I would have the opportunity to purchase 24 tickets!  This scales at 8 tickets per computer.  So 10 computers allows you to purchase 80 tickets (or 8% of all tickets avaliable!).</p>

<p>For those with more resources, you can go to a public library or a college&rsquo;s computer lab to install an apply this extension to an even larger number of computers.</p>

<h2>Conclusion</h2>

<p>Feel free to hack and fork this tool as much as you would like.  I really hope that everyone enjoyed reading this as much I as I enjoyed writing it. Best of luck to everyone buying tickets this weekend!</p>

<h2>Notes</h2>

<p>I would be careful about opening too many tabs, because they may actually slow down the process.  In experimentation, I was able to grab 2 tickets to an event I created with 12 tabs within 10 seconds of the release.</p>

<p>This currently attempts to grab the maximum amount of tickets (2).</p>

<h1>PLEASE PLEASE PLEASE check back with the project an hour before tickets become avaliable.  I plan on releasing an updated version of the project to handle any issues that may arise.</h1>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/24/how-to-make-a-gem/">Extending Active Record in Rails 4.1</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-24T04:40:48+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:40 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>A great way to extend rails functionality is by using Rails gems.  These libraries are easily plugged into existing ruby projects and allow for quick integration of complicated features.</p>

<p>I noticed that for my side projects that are still growing, that I would like to be notified whenever a new user signs up, so I can reach out to them to get feedback on the product.</p>

<p>Here I will go through step by step on how I created <a href="https://github.com/KevinColemanInc/Angora">Angora</a>, email notifications on model creation</p>

<h1>The art of naming</h1>

<p>Firstly, select a name.  This name should be unique to other gems so other developers can easily find it.  Check <a href="http://github.com">Github</a> and <a href="http://rubygems.org">RubyGems</a> to verify that there aren&rsquo;t any other gems with the same name.</p>

<p>RubyGems provides a excellent <a href="http://guides.rubygems.org/name-your-gem/">table</a> for describing how to name a gem.</p>

<h1>Creating the gem</h1>

<p>We are going to use the bundler tool to generate the gem files.  Since my gem name is angora, I type this in:</p>

<figure class='code'><figcaption><span>Creating gem with bundler</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ bundle gem angora</span>
</span><span class='line'><span class="go">    create  angora/Gemfile</span>
</span><span class='line'><span class="go">    create  angora/Rakefile</span>
</span><span class='line'><span class="go">    create  angora/LICENSE.txt</span>
</span><span class='line'><span class="go">    create  angora/README.md</span>
</span><span class='line'><span class="go">    create  angora/.gitignore</span>
</span><span class='line'><span class="go">    create  angora/angora.gemspec</span>
</span><span class='line'><span class="go">    create  angora/lib/angora.rb</span>
</span><span class='line'><span class="go">    create  angora/lib/angora/version.rb</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Upload to github</h1>

<p>Lets add this project to github and start tracking it with git.  This will also give us a homepage to link to, which we will get to next.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ git init</span>
</span><span class='line'><span class="go">  $ git add -all</span>
</span><span class='line'><span class="go">  $ git commit -m &quot;first commit!&quot;</span>
</span><span class='line'><span class="go">  $ git remote add origin &lt;git url&gt;</span>
</span><span class='line'><span class="go">  $ git push origin master</span>
</span></code></pre></td></tr></table></div></figure>


<h1>The basics</h1>

<p>Now we are going to edit the basic attributes of angora.  Open up <code>angora.gemspec</code> to see all of the generated defaults.  Change all of the attributes to what is relevant for your project.</p>

<figure class='code'><figcaption><span>angora.gemspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">authors</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Kevin Coleman&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">email</span>         <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;kevin.coleman@gatech.edu&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">summary</span>       <span class="o">=</span> <span class="sx">%q{TODO: Get notifications when a new object is created.}</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">description</span>   <span class="o">=</span> <span class="sx">%q{TODO: Angora hooks into ActiveMailer to send off an email notification with all of the</span>
</span><span class='line'><span class="sx">  spec.homepage      = &quot;https://github.com/KevinColemanInc/angora&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Dependencies</h1>

<p>Because this gem depends on active record, I need to add that as a dependency to the gem.  We will also be using rspec to test the gem.</p>

<figure class='code'><figcaption><span>angora.gemspec</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_dependency</span> <span class="s2">&quot;activerecord&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;rspec&quot;</span>
</span><span class='line'>  <span class="n">spec</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;sqlite3&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>and I need to require it in the gem file, so it loads with the gem.</p>

<figure class='code'><figcaption><span>lib/angora.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s2">&quot;active_record&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>First Test</h1>

<p>Following TDD practices, we must first write our tests before we start writing feature code.  I am going to use rspec.</p>

<figure class='code'><figcaption><span>spec/lib/angora_spec.rb linenos:true</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s2">&quot;angora_spec&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">context</span> <span class="s2">&quot;send notification&quot;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">it</span> <span class="s2">&quot;should send a notification message&quot;</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;Kevin&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will verify that a notification has been sent when the user is created.  For this test to run, we will need to create the <code>spec_helper.rb</code> file.</p>

<figure class='code'><figcaption><span>spec/lib/angora_spec.rb linenos:true</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;angora&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">establish_connection</span><span class="p">(</span><span class="ss">:adapter</span> <span class="o">=&gt;</span> <span class="s2">&quot;sqlite3&quot;</span><span class="p">,</span>
</span><span class='line'>                                       <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/angora.sqlite3&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">load</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/support/schema.rb&#39;</span>
</span><span class='line'>  <span class="nb">load</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/support/models.rb&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>require 'angora'</code> will add references to our gem and active_record that our tests will need to run.  We will need a database to test our gem against, so I am establishing a connection to a local sqlite3 database.</p>

<p>After the database is loaded, we will need to load up a schema file so rails can use that schema.</p>

<figure class='code'><figcaption><span>spec/support/schema.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="o">.</span><span class="n">define</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:force</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the schema file like above.  Because this is just for testing, I am only creating one model and only giving it one attribute, name.</p>

<p>We will also have to create the user model class.</p>

<figure class='code'><figcaption><span>spec/support/schema.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/18/reporting-with-rails-part-1/">Reporting With Rails Part 2</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-18T06:49:55+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:49 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is version two of my reporting schema used for Focused Care Solutions reporting to case managers.  This pattern follows contains a lot of the benefits of the first one, except hides a lot of the code messiness.</p>

<h2>Goodbye lib/reports.rb</h2>

<p>I hated how cluttered and ugly reports.rb got.  It ended being a graveyard for code decay causing a massive file (+500 lines of SQL/Ruby code) making it crazy difficult to maintain and find things in.  Sooo much scrolling.</p>

<h2>Hello migrations!</h2>

<p>This time I moved all of my SQL to be the data layer.  Everything was self contained in a reporting row.</p>

<figure class='code'><figcaption><span>_create_reports.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:reports</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="ss">:uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">text</span> <span class="ss">:sql</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The reports model only contains the name of the report and the sql for this report.  The column formatting will be done within the query (no more slow ruby helper methods) and the user friendly column headers will be in the select.  PGResult gives you an array of all of the headers that you can loop through.</p>

<p>To add a report you simply create a migration and add the report in it:</p>

<figure class='code'><figcaption><span>add_all_member_report.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT</span>
</span><span class='line'><span class="s1">           email as &quot;email&quot;,                 </span>
</span><span class='line'><span class="s1">           sign_in_count as &quot;sign in count&quot;,</span>
</span><span class='line'><span class="s1">           last_sign_in_at as &quot;last sign in at&quot;,</span>
</span><span class='line'><span class="s1">           created_at as &quot;created at&quot;,</span>
</span><span class='line'><span class="s1">           updated_at as &quot;updated at&quot;,</span>
</span><span class='line'><span class="s1">           archived_at as &quot;archived at&quot;,</span>
</span><span class='line'><span class="s1">           first_name as &quot;first name&quot;,</span>
</span><span class='line'><span class="s1">           last_name as &quot;last name&quot;,</span>
</span><span class='line'><span class="s1">           phone_number as &quot;phone number&quot;,</span>
</span><span class='line'><span class="s1">           member_number as &quot;member number&quot;,</span>
</span><span class='line'><span class="s1">           date_of_birth as &quot;date of birth&quot;,</span>
</span><span class='line'><span class="s1">           note as &quot;note&quot;</span>
</span><span class='line'><span class="s1">          FROM Users&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Report</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
</span><span class='line'>      <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;All Members&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">sql</span><span class="p">:</span> <span class="n">sql</span>
</span><span class='line'>      <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This way, new developers only and new deployments have to run migrations when they are setting up a new box and you get a history of what each report was.  If you want to edit a report, find it by the name and change the SQL code.</p>

<h2>reports_controler.rb</h2>

<p>I broke reports controller into two controller files.  One going in the API folder and one going in the top level reports folder.  The top level folder handles all of the HTML methods with reporting while the API actually runs the report.  This way the users arent stuck with a long page load time while the report is being run and I can leverage AngularJS to display the report results.</p>

<figure class='code'><figcaption><span>reports_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ReportsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:set_report</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="o">]</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">load_and_authorize_resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>    <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_report</span>
</span><span class='line'>      <span class="vi">@report</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Only the index and show methods are needed here.  We dont want regular users to created or edit reports (yet).  Show and Index methods handle the AngularJS HTML and, for the show, writes the report_id to tell the javascript what report to run.</p>

<figure class='code'><figcaption><span>api/v1/reports_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">API</span><span class="o">::</span><span class="no">V1</span><span class="o">::</span><span class="no">ReportsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">respond_to</span> <span class="ss">:json</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:authenticate_user_from_token!</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:authenticate_user!</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:set_report</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">load_and_authorize_resource</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@meter</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:index</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>    <span class="vi">@results</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="vi">@report</span><span class="o">.</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="n">render</span> <span class="ss">:run</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>  <span class="c1"># Use callbacks to share common setup or constraints between actions.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">set_report</span>
</span><span class='line'>      <span class="vi">@report</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here the code is stupid simple.  There isnt any complicated formatting or send functions.  All acts as a layer between the view and the data, as it should.</p>

<h2>run.json.jbuilder</h2>

<p>Json for each report gets rendered with this view method.  Thanks to PGResult, you get a seperate list of the headers from the data.  I included that seperately from the data, so that it would be easier for the Javascript to find and render the form data.</p>

<figure class='code'><figcaption><span>run.json.jbuilder</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">json</span><span class="o">.</span><span class="n">table</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">json</span><span class="o">.</span><span class="n">headers</span> <span class="vi">@results</span><span class="o">.</span><span class="n">fields</span>
</span><span class='line'>  <span class="n">json</span><span class="o">.</span><span class="n">rows</span> <span class="vi">@results</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Pros</h2>

<ul>
<li>Hides the SQL in the database, keeping the code base clean.</li>
<li>The view is report agnostic.  You dont have to write a separate view per report.</li>
<li>Custom SQL == more control over reports behavior</li>
<li>You dont have to deploy to update a reporting query, but dont forget to write a migration for it.</li>
<li>Dynamically loaded via JSON, this allowing multiple clients to run reports.  (maybe a mobile app?)</li>
</ul>


<h2>Cons</h2>

<ul>
<li>You have to format on the database side, which makes writing the query more annoying, because you cant use Rails helper methods.</li>
<li>Editing Queries can be a little annoying, because you have to look up what is currently in the DB and create a migration to view it.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/11/reporting-with-rails-p1/">Reporting With Rails Part 1</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-11T18:05:11+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:05 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have worked on several projects that need a reporting tool to present the data models in a complex manor.  I often find these queries to get more complicated than ActiveRecord is able to handle (think needing sub-arqueries or joining against tables that aren&rsquo;t represented by models).  As a result, I have to write raw SQL queries to handle the data retrieval.  This can get ugly very quickly if you are not careful on how you structure your framework for storing these queries.</p>

<p>I am going to describe the two ways that I have solved this issue and give you the pros and cons of each.  This will be the first article of two describing what the first iteration of this framework and why I choose to redesign it to something else.</p>

<h2>reports.rb</h2>

<p>The first strategy involved creating a model called &lsquo;reports&rsquo;.  This model only contained basic information of the report: (name, url_name, created_at, etc.)</p>

<p><img src="/images/report_diagram.png" title="Report ER Diagram" width="180px"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="ss">:reports</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="ss">:uuid</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:url_name</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:description</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>For every report we wanted to have, we would create a new entry in the database with that information filled out.</p>

<p>These reports need to be install via rake tasks or migrations (to be honest, my personal preference is to use migrations, because when setting up a new box, you wont have to remember to run this other task).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="no">Report</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span>
</span><span class='line'>    <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;All Users&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">url_name</span><span class="p">:</span> <span class="s2">&quot;all_users&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">description</span><span class="p">:</span> <span class="s2">&quot;show all users in the database&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>lib/reports.rb</h2>

<p>Now that we know what reports are available, the next step is create their methods.  Each report gets its own method in lib/reports.rb, because that is where we will be storing the SQL and formatting rules for each of them.</p>

<p>An example report would look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="kp">include</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">NumberHelper</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">all_users</span>
</span><span class='line'>  <span class="n">table_headers</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Email&#39;</span><span class="p">,</span> <span class="s1">&#39;Account Balance&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT id, name, email, balance FROM users&quot;</span>
</span><span class='line'>  <span class="n">query_results</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">results</span> <span class="o">=</span> <span class="o">[</span><span class="n">table_headers</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">query_results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">query_result</span><span class="o">|</span>
</span><span class='line'>    <span class="n">results</span> <span class="o">+=</span> <span class="o">[</span><span class="n">query_result</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span><span class="n">query_result</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">,</span><span class="n">query_result</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span><span class="p">,</span> <span class="n">number_to_currency</span><span class="p">(</span><span class="n">query_result</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span><span class="p">)</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">results</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each method returns a [NxM] array of the results, ready to displayed in the html.  Pagination and sorting have been withheld from this example, as they are trivial to add in.  <a href="https://github.com/amatsuda/kaminari">Kaminari</a> gem handles pagination very nicely, although for larger reports, I letting the database handle the pagination, ruby will have to loop through all of the data points, which is expensive.</p>

<h2>reports_controller.rb</h2>

<p>Next a reports controller needs to get made.  This will have two methods in it: index, and show.</p>

<p>All index will do is show the list of report names and links to them (we used a drop down box with textboxes for begin and end date selectors).  Show is where the report will be displayed.  We probably should of made this an AJAX callback and requested the results separately, but I will get to that later.</p>

<p>The show method would grab from the URL the url_name of the report being run.  Then it would run <a href="http://ruby-doc.org/core-2.1.1/Object.html#method-i-send">.send</a> to execute the method name of the string in the lib/reports.rb class.  The results were written to a table element with a timestamp of when the report was run.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>  <span class="vi">@report</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">find_by_url_name</span><span class="p">(</span><span class="ss">:url_name</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@results</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="vi">@report</span><span class="o">.</span><span class="n">url_name</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://brakemanscanner.org/">Brakeman</a> hates this, because using .to_sym on any parameter is a huge security flaw.  This reporting engine was locked behind <a href="https://github.com/ryanb/cancan">CanCan</a>/<a href="https://github.com/plataformatec/devise">Devise</a> and only staff members had access to this page.  But someone malicious could of done a lot of damage to the system if abused.</p>

<h2>Pros</h2>

<ul>
<li>Custom sql == more control over the queries allowing for greater efficiency</li>
<li>SQL is managed in GIT, so you can easily view the changes</li>
<li>Formatting is handled by RoR, which lets you make use of the helper methods</li>
<li>Because the SQL lives in code, you can leverage ruby by creating custom ruby methods to generate portions of SQL.  (think a method the lets all reports sharing the same where conditions for datetime restrictions)</li>
</ul>


<h2>Cons</h2>

<ul>
<li>You will end up with a massive lib/reports.rb file, which can be difficult to maintain</li>
<li>Because the formatting is handled by ruby, the report may run a little slow</li>
<li>Security flaw with the .send</li>
<li>Difficult to maintain.  If you change a column, then you have to modify your code a bunch of different places.</li>
<li>Database dependency means for new deployments, a rake task, database migration, or seed must be run in order for the website to reflect the new reports</li>
</ul>


<p>Part 2 will be linked here.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/14/setting-up-a-ruby-on-rails-4-dot-0-1beta1-with-osx-mavericks-10-dot-9/">Setting Up a Ruby on Rails 4.0.1beta1 With OSX Mavericks 10.9</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-02-14T07:21:15+01:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:21 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>I keep having to setup Rails environments for people so I am just going to write my first blog article on how to do it on OSX 10.9.</p>

<h2>Installing the Command line tools</h2>

<p>The GCC compiler is required with installing RVM and Brew, so you need to download and install the xcode command line tools.  Open terminal and type in this:</p>

<figure class='code'><figcaption><span>Install Command line tools</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ xcode-select --install</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Installing HomeBrew</h2>

<p>Homebrew is a package manager that makes it stupid easy to install and update software.  We will be using this tool to install Git, Postgres, and RVM.  To install this tool enter this into the terminal:</p>

<figure class='code'><figcaption><span>Installing HomeBrew</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ ruby -e &quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go/install)&quot;</span>
</span><span class='line'><span class="go">  $ brew doctor</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first command fetches and installs brew.  The second will update brew and fetch the latest installation scripts</p>

<h2>Installing Postgres</h2>

<p>Most guides recommend installing MySQL as the db engine, but because Heroku defaults to Postgres and Postgres is the hot right now, I use it in dev and in my production environments.</p>

<p>To install, type this command into the terminal:</p>

<figure class='code'><figcaption><span>Installing Postgres</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ brew update</span>
</span><span class='line'><span class="go">  $ brew install postgresql</span>
</span></code></pre></td></tr></table></div></figure>


<p>At the end of the install, follow the instructions for how to startup the server.  I would recommend to have it autostart with login, so you dont have to think about it.  If you wish to manually start it when you need it, dont lose that command to start it.</p>

<h2>Installing RVM</h2>

<p>RVM is a ruby version manager.  It allows you to install multiple versions of ruby on your computer and easily switch between them.  This is important because as new versions of ruby on released, you will want to be able to test websites before deploying them and you may need to switch back to an old version if you encounter bugs.</p>

<figure class='code'><figcaption><span>Installing RVM</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ \curl -L https://get.rvm.io | bash -s stable</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Install Rails</h2>

<p>To install the rails toolset type in this to terminal:</p>

<figure class='code'><figcaption><span>Installing Rails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ gem install rails</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gives you rails command in terminal and allows you to create new rails websits.  To verify this installed properly type:</p>

<figure class='code'><figcaption><span>Installing Rails</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ rails --version</span>
</span><span class='line'><span class="go">  Rails 4.1.0.beta1 </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Installing Git</h2>

<p>git is the most common tool for managing source code.  I would recommend creating an account on github and using that as your source control.  Check out these guides for a quick start with git</p>

<h3>Quick start git guide from the terminal</h3>

<p>This is one of the best guides I could find on how to quickly emerse yourself into git.
<a href="http://rogerdudler.github.io/git-guide/" title="Git Guide">Git Guide</a></p>

<h3>GitHub flow</h3>

<p>I uses this pattern for the repo if more than one person is working on it.
<a href="http://scottchacon.com/2011/08/31/github-flow.html" title="Github Flow">What is GitFlow?</a></p>

<h3>To install Git CLI</h3>

<p>In order to have the most amount of control over your git repo, you will need to install the Git CLI.  Using the CLI can be intimidating at first, but it is definately worth learning.</p>

<figure class='code'><figcaption><span>Git CLI</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ brew update</span>
</span><span class='line'><span class="go">  $ brew install git</span>
</span></code></pre></td></tr></table></div></figure>


<h3>To install Github GUI</h3>

<p>I also use Githubs GUI tool because it makes committing easier.  Unfortunately it tends to fall flat on its face outside of the happy path (read merge conflicts and rebasing), so you cant completely rely on this tool for git management.</p>

<p>Follow the instructions here
<a href="http://mac.github.com/" title="Github tool">Github for mac</a></p>

<h2>Install Heroku toolbelt</h2>

<p><a href="http://Heroku.com/" title="Heroku">Heroku</a> is a popular hosting service for rails applications, mostly because it is free and easy to use.</p>

<p>Make an account at <a href="http://Heroku.com/" title="Heroku">http://heroku.com/</a></p>

<p>Install the toolbelt found here <a href="https://toolbelt.heroku.com/" title="Heroku Toolbelt">Heroku Toolbelt</a></p>

<h2>Optional: Installing Sublime</h2>

<p>Sublime is probably the most common text editor for Rails development.  You can download it here: <a href="http://www.sublimetext.com/" title="Sublime">Sublime</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Kevin Coleman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  








  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
