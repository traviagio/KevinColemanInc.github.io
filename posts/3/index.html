
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Kevin Coleman</title>
  <meta name="author" content="Kevin Coleman">

  
  <meta name="description" content="I get asked a lot about what it takes to break into the Ruby on Rails industry at the various hackathons and start up weekends I have attended. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.kcoleman.me/posts/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Kevin Coleman" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-48081941-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Kevin Coleman</a></h1>
  
    <h2>makes apps for businesses with Ruby on Rails.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/KevinColemanInc" rel="subscribe-github" title="@KevinColemanInc on GitHub"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://plus.google.com/+KevinColemanInc" rel="publisher" title="Google+ Profile"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 23.03264,55.19021 C 32.01805,55.457578 38.046082,46.137447 36.495958,34.370183 34.943794,22.603939 26.398215,13.161349 17.411784,12.89296 8.4253533,12.625592 2.3973217,21.630392 3.9494863,33.400718 5.5006303,45.164921 14.043148,54.921821 23.03264,55.19021 z M 99.99898,24.999027 100,0 -0.00797206,0 0.0052943,16.202408 C 5.7047282,11.184661 13.611481,6.9914696 21.771315,6.9914696 c 8.721103,0 34.888495,0 34.888495,0 l -7.807765,6.6035874 -11.062106,0 c 7.33732,2.81349 11.246815,11.3407 11.246815,20.090377 0,7.348545 -4.082979,13.667416 -9.852826,18.161652 -5.629021,4.385043 -6.696453,6.220904 -6.696453,9.948752 0,3.180866 6.030073,8.594563 9.183386,10.81923 9.217061,6.498477 12.199952,12.530591 12.199952,22.603843 0,1.604209 -0.198996,3.206378 -0.591884,4.780993 L 100,100 c 0,0 0,-46.594917 0,-68.751495 l -18.750474,0 0,18.750475 -6.250499,0 0,-18.750475 -18.750474,0 0,-6.250498 18.750474,0 0,-18.7494538 6.250499,0 0,18.7494538 18.750474,0 z M 18.147557,74.798916 c 2.111393,0 4.04522,-0.05817 6.048441,-0.05817 -2.651232,-2.571634 -4.749358,-5.722905 -4.749358,-9.606889 0,-2.305285 0.738834,-4.52485 1.77157,-6.496436 -1.053145,0.0745 -2.127721,0.09695 -3.234952,0.09695 -7.261803,0 -13.4286215,-2.351208 -17.99020957,-6.236212 l 0,6.56685 0.00102048,19.70055 C 5.2128523,76.28781 11.409265,74.798916 18.147557,74.798916 z M 44.474145,93.051391 C 43.002599,87.308076 37.788918,84.46091 30.518951,79.420713 c -2.644088,-0.85313 -5.556565,-1.35521 -8.681304,-1.387866 -8.752739,-0.09389 -17.2452523,3.525266 -21.84561906,8.743028 l 0,13.224125 44.64641606,-0.0011 c 0,0 0.263286,-2.21038 0.263286,-3.362512 -10e-4,-1.222547 -0.151032,-2.419581 -0.427585,-3.58498 z"></path></svg></a></li>
</ul>
  
  
  
    
      <form action="https://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="q" value="site:www.kcoleman.me" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/coleman-laws">Coleman Laws</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/13/entry-level-rails/">What It Takes to Be Entry Level Rails Developers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-13T13:42:01-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>1:42 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/bridge.jpg" title="What it takes to be entry level Rails developers" class="banner-img" /></p>

<p>I get asked a lot about what it takes to break into the Ruby on Rails industry at the various hackathons and start up weekends I have attended.  Spurred by this <a href="http://www.reddit.com/r/ruby/comments/282n9k/what_ruby_skills_are_essential_for_an_entrylevel/">/r/ruby question</a>.  I shall try my best to answer this question in a public setting.</p>

<h2>I want to this in an entry level rails developer</h2>

<ol>
<li>Build a <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUDL</a> application</li>
<li>Understand and apply <a href="http://getbootstrap.com/">bootstrap</a></li>
<li>Build a to-do application or any simple super basic app that requires a few controllers, models, etc.</li>
<li>Use slightly obscure gems, like the <a href="https://github.com/sferik/twitter">twitter</a>, <a href="https://github.com/arsduo/koala">koala</a>, <a href="https://rubygems.org/gems/mandrill-api">mandrill</a>, <a href="https://github.com/amatsuda/kaminari">kaminari</a>, <a href="https://github.com/rails/jbuilder">jbuilder</a>, etc. to prove to me that they can read the documentation and figure out how to use a gem.</li>
</ol>


<h2>Bonuses</h2>

<ol>
<li>Understanding a testing framework (<a href="https://github.com/rspec/rspec-rails">rspec</a> is my preference)</li>
<li>Knowing some basic javascript (jquery)</li>
<li>Know <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a></li>
<li>Knowing Thin Controllers, Fat Models</li>
<li>Attends the local ruby on rails <a href="http://meetup.com">meetup</a></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/05/rails-4-dot-1-enums-how-not-to-handle-states/">Rails 4.1 Enums: How Not to Handle States</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-05T10:08:29-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:08 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/road.jpg" title="Rails 4.1 enums: How not to handle stats" class="banner-img"/></p>

<p>I subscribe to the <a href="http://rubyweekly.com/">Ruby Weekly</a> news blog, so I can stay updated with the latest rails practices and gems.  90% of the time, there is some really good information in there.  But occasionally, sometime catches my eye that just feels wrong.</p>

<p>In this weeks email, there was a post linking to <a href="https://www.youtube.com/watch?v=UbOkNduhCfw">An introduction to Rails 4.1&rsquo;s Enum</a> where he talks about how you should use enums to handle your model states.</p>

<p><em>This upset me.</em></p>

<p>You really shouldn&rsquo;t be using enums for variables that don&rsquo;t have a strong numerical meaning (like in the example below), because it obscures the meaning of the variable&rsquo;s value.</p>

<h2>What are Enums</h2>

<p>For those that don&rsquo;t know what enums are, they essentially allow you to give names to integers.  This is really cool, because I can do things like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">enum</span> <span class="ss">http_code</span><span class="p">:</span> <span class="p">{</span> <span class="ss">continue</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="ss">ok</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="ss">accepted</span><span class="p">:</span> <span class="mi">202</span><span class="p">,</span> <span class="ss">redirection_perm</span><span class="p">:</span> <span class="mi">301</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I can have named response codes to http codes.   I can do things like <code>response.http_code == :ok</code> to see if the response was valid.  Now I wont have to remember all of those http numbers, I can just remember the names of them.</p>

<p>That is what enums are good for.  State is what enums are bad for. Unfortunately the <a href="https://github.com/codemy/blogmenow/pull/3/files">example code</a> for using them in rails suggests that you use them for state.</p>

<h2>Why enums are bad</h2>

<p>Yeah, its great to have name attributes for numbers, but this gets bad when you start putting them in the database and the numbers don&rsquo;t really mean much by themselves, which is how you would look at them if you were to hit the database directly with a query.</p>

<h3>Only exist inside of the application</h3>

<p>So if my states are like so with the order being pending => processing => accepted => complete</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">enum</span> <span class="ss">state</span><span class="p">:</span> <span class="p">{</span> <span class="ss">pending</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">processing</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">accepted</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">complete</span><span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will only see numbers in the database.  If I do an export of the db to hand to my data analyst, he is going to have no idea what those numbers mean.  Now I have to include my db dump and my .rb file with the enums spelled out.</p>

<p>Or perhaps, you have a <a href="http://nodejs.org/">nodejs</a> application powering your chat service that also accesses the same db.  In the nodejs world, you would have to maintain a similar enum list so it can read from the states.  Your nodejs developer would have to reference your .rb file to determine what number really means what.</p>

<h3>Growth causes confusion</h3>

<p>This will also get confusing as your application grows you may want to add more states. You may end up with something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">enum</span> <span class="ss">state</span><span class="p">:</span> <span class="p">{</span> <span class="ss">pending</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">processing</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="ss">accepted</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="ss">complete</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="ss">shipping</span><span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The new order would be pending => processing => accepted => shipping => complete.  Which is awkward, because in the database, it looks like 1 => 2 => 3 => 5 => 4.  Which can feel a bit weird if you don&rsquo;t know what is going on.</p>

<p>If you had just left your states as named strings, you wouldn&rsquo;t have this odd ordering issue or this ambiguity of what number resides with what state.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/04/path-to-success/">My Path to Success</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-06-04T14:50:34-07:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:50 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/escalator.jpg" title="My path to success" class="banner-img" /></p>

<p>My first and foremost goal is to become a successful entrepreneur.  Unfortunately, I am still working on trying to get there.  While my <a href="/coleman-laws">grandfather&rsquo;s laws</a> make a great guide for running a business, I don&rsquo;t have a business yet to run.</p>

<p>After talking with many other successful entrepreneurs, I find that everyone has to find their own path to success, but you can learn from what the greats have to say and let their advice guide you.</p>

<h2>Get out of the house</h2>

<p>I work remotely.  My day consists of waking up, working, going to Publix for food, saying hello to the checkout lady and then returning home for more work.  It is relationships with other people that <a href="http://money.usnews.com/money/personal-finance/articles/2012/03/15/why-good-friends-make-you-happy">lead to happy</a> and successful lives.</p>

<p>While I can function completely fine by working from my home office, I need to get out of the house.  I need to connect with other people to build a strong business network.  For me, I build these relationships through my local <a href="http://www.meetup.com/find/events/?keywords=programming">programming meetups</a>, attending <a href="http://startupweekend.org/">startup weekends</a>, or any <a href="http://startupgossip.com">other start up events</a>.</p>

<h2>Keep coding</h2>

<p>My day job is freelance coding rails.  I spent 8-10 hours sitting on my computer developing models, controllers, and whatever else my clients need to keep cashflow coming in, but that is boring.  I need to keep my skills sharp and balanced.</p>

<p>Great! I know ruby on rails really well, but I want to be good at lots of different tools, because I have no idea what skills I will need in the future.  That is why I play with different frameworks like <a href="/blog/2014/04/30/nodejs-chat-guide/">NodeJS</a> or <a href="blog/2014/03/11/reporting-with-rails-p1/">AngularJS</a>.</p>

<h2>Stay focused on your goals</h2>

<p>I attended the professional speakers <a href="http://www.toastmasters.org/">Toast Master&rsquo;s</a> group a few months ago and one of the speakers was in the process of writing a &ldquo;self-help guide to success&rdquo; book.  Her name and the bookâ€™s escapes me, but she had an interesting technique for staying focused on life.  Every morning, write your goals in a journal.  This starts your day off thinking about what you want to accomplish and keeps it focused on detecting signals that may help you accomplish your goals.</p>

<h2>Keep a short list</h2>

<p>I find myself in situations where I think: &ldquo;Great! I have nothing to do right now.&rdquo; Bullshit.  There are always things to do, I find my mind is terrible about coming up with them once its entered that state.</p>

<p>Whenever I come up with a task that needs to get done, I toss it into my <a href="http://wunderlist.com">Wunderlist</a> inbox.  Now I find that I have a moment with nothing scheduled, I can always look their for guidance.  I only put short actionable items in that list like: do laundry, ready <a href="http://engineering.richrelevance.com/bandits-recommendation-systems/">this</a> article on recommendation systems, or check <a href="http://www.zillow.com">Zillow</a> for homes.</p>

<p>Hopefully by following these goals, I will stumble through life and find myself retired by athange 30, ha!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/31/twitter-bot-on-heroku/">Twitter Bot on Heroku</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-31T21:05:08-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>9:05 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/alley.jpg" title="Twitter bot v1 on Heroku" class="banner-img" /></p>

<p>Inspired by the Technology Review article, <a href="http://www.technologyreview.com/view/527746/how-advanced-socialbots-have-infiltrated-twitter/">How Advanced Social bots Have Infiltrated Twitter</a>, I thought it would be an interesting to see how difficult it is to write a bot to generate followers over a given topic.</p>

<p>I think a first basic start would be to post proven social content from other sources (namely <a href="http://reddit.com/">reddit.com</a>).  Version one of the bot will just repost the top article of the day on a given sub-reddit onto this twitter account.  Lets get started.</p>

<h2>Import the gems</h2>

<p>First I need to create my <code>Gemfile</code> and reference these gems:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;twitter&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;redditkit&#39;</span><span class="c1">#, :git =&gt; &#39;https://github.com/samsymons/RedditKit.rb.git&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;redis&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a number of reddit gems, but I found that <a href="https://github.com/samsymons/RedditKit.rb">redditkit</a> seems to be the most maintained.</p>

<p>Redis will be used as our data store to prevent duplicate tweets.</p>

<h2>Twitter Bot code</h2>

<figure class='code'><figcaption><span>twitter_bot.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;twitter&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;redditkit&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;redis&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;open-uri&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">KARMA_THRESHOLD</span><span class="o">=</span><span class="mi">2000</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we need to require all of the resources.  Unfortunately these are not automatically loaded like they are in rails.  I set the KARMA_THRESHOLD to a score of 2000, so that we only share quality content.  <code>open-uri</code> will be used with the image upload.  If you upload the image as opposed to sharing the link, the photo will appear in the stream, thus giving it more exposure.</p>

<figure class='code'><figcaption><span>twitter_bot.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;REDISCLOUD_URL&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="s2">&quot;redis://localhost:6379/&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;REDISCLOUD_URL&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;REDISCLOUD_URL&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="vg">$redis</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">uri</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="n">uri</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">uri</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since I am hosting this with Heroku, I need to set a default environment variable for the rediscloud_url which is set by the <a href="http://redislabs.com/redis-cloud">Redis cloud addin</a></p>

<p>Next I configure the twitter gem with the API keys I got from their website</p>

<figure class='code'><figcaption><span>twitter_bot.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span>        <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span>     <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token</span>        <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">authenticated_client</span> <span class="o">=</span> <span class="no">RedditKit</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'><span class="n">posts</span> <span class="o">=</span> <span class="n">authenticated_client</span><span class="o">.</span><span class="n">links</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="ss">:category</span> <span class="o">=&gt;</span> <span class="ss">:top</span><span class="p">,</span> <span class="ss">time</span><span class="p">:</span> <span class="ss">:hour</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also login to my reddit account and retrieve the links for the sub-reddit of my choice.</p>

<h2>Loop through all of the links and find something to share</h2>

<figure class='code'><figcaption><span>twitter_bot.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">posts</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="no">KARMA_THRESHOLD</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">link</span><span class="o">[</span><span class="ss">:domain</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;imgur.com&quot;</span> <span class="o">||</span> <span class="n">link</span><span class="o">[</span><span class="ss">:domain</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;i.imgur.com&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="vg">$redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link:&#39;</span><span class="o">+</span><span class="n">link</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">include?</span> <span class="s2">&quot;r/&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">include?</span> <span class="s2">&quot;i.imgur&quot;</span>
</span><span class='line'>      <span class="n">image_url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">url</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">image_url</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/http:\/\//</span><span class="p">,</span> <span class="s1">&#39;http://i.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.jpg&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;cringe.png&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">fo</span><span class="o">|</span>
</span><span class='line'>      <span class="n">fo</span><span class="o">.</span><span class="n">write</span> <span class="nb">open</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="vg">$redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;link:&#39;</span><span class="o">+</span><span class="n">link</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">update_with_media</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; #LOL &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;cringe.png&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="k">break</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I want to only select links with a high enough karma score, with an imgur image, and not in my redis store and not referencing another reddit thread.  I don&rsquo;t want them to include any reddit references in my tweets if I can help it.</p>

<p>Sometimes people post a link to the imgur page instead of directly to the link, so I need to change up the image_url as necessary depending on whether or not they did so.</p>

<p>Next I download the image so I can re-upload it to twitter later.   Next I create the token in my redis store so I don&rsquo;t accidently have any duplicate image links.  I check against that in the if statement above.</p>

<p>Now I update my twitter feed with the link title, a hash tag, and the new image I just downloaded.  Because I am running this on Heroku, the image saved to disk will get lost when the dyno gets killed with the scheduler ends.  So I don&rsquo;t really need to worry about clean up.</p>

<p>I want this to only run once, because twitter will get upset if they notice that fire off tweets in bursts.  I think once per day is a good starting ground and I can move up the frequency, as I get more and more brave.</p>

<h2>Deploy to Heroku</h2>

<p>I need to make this a git repo, add my code so far.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">git init</span>
</span><span class='line'><span class="go">git add .</span>
</span><span class='line'><span class="go">git commit -m &quot;first twitter bot commit!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I need to make the <a href="http://heroku.com">Heroku</a> application to run this under and push it up to the server</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">heroku apps:create twitter-bot</span>
</span><span class='line'><span class="go">git push heroku master</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Heroku Scheduler</h2>

<p>Heroku comes with a free scheduler that I can run in daily increments, perfect for this application.  I set configure it so it runs <code>ruby twitter_bot.rb</code> every day at midnight, so users will be able to see my tweets in the morning when they wake up.</p>

<h2>In the future&hellip;.</h2>

<p>I plan on adding more content sources and more frequent posts.  I am running this along side the chrome extension <a href="https://github.com/ztratar/followr">Followr</a>, which is an automated tool for favoriting tweets of other users based on preset hash tags.  So far it has earned me 10 new followers and 3 new re-tweets.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/31/url-shorter-with-redis-and-rails/">Rails and Redis URL Shortener in Same Application</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-31T11:22:47-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span> <span class='time'>11:22 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/locks.jpg" title="Redis key value storage" class="banner-img" /></p>

<p>Here is how to build a quick URL shortener in Rails 4.0 that shares the same application as the rest of your project, but is meant to run on a different domain using <a href="http://redis.io/">Redis</a>.</p>

<h2>Installing Redis</h2>

<p>I recommend just using <a href="http://brew.sh/">brew</a> to install redis.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  brew install redis</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to start it up, open a new terminal window and type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">redis-server</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Link Model creation</h2>

<p>Redis maybe great for quick access to information, but it does not guarantee like an <a href="http://en.wikipedia.org/wiki/ACID">ACID compliant</a> database does that the information you put there will always be there.  Because it is a <a href="http://en.wikipedia.org/wiki/NoSQL">noSQL</a> key-value store in memory, if the server it is running against restarts, its entire memory will be lost and you will need to have a reliable back up so you can re-generate the storage as needed.</p>

<figure class='code'><figcaption><span>migration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">create_table</span> <span class="s2">&quot;links&quot;</span><span class="p">,</span> <span class="ss">force</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="s2">&quot;created_at&quot;</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">datetime</span> <span class="s2">&quot;updated_at&quot;</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="s2">&quot;short_code&quot;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">string</span>   <span class="s2">&quot;long_url&quot;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="s2">&quot;click_count&quot;</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The short code will be a 6-8 digit representation of the longer link which will be stored in the <code>long_url</code> field.  I also want to store the click count of these links, so I am adding that as an attribute as well.</p>

<h2>Link Model code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Link</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">validates</span> <span class="ss">:long_url</span><span class="p">,</span> <span class="ss">:click_count</span><span class="p">,</span> <span class="ss">:long_url</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">after_create</span> <span class="ss">:store_in_redis</span>
</span><span class='line'>  <span class="n">before_create</span> <span class="ss">:set_short_code</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redis_url_key</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span class='line'>    <span class="s1">&#39;link:&#39;</span><span class="o">+</span><span class="n">short_code</span><span class="o">+</span><span class="s1">&#39;:url&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">redis_clicks_key</span><span class="p">(</span><span class="n">short_code</span><span class="p">)</span>
</span><span class='line'>    <span class="s1">&#39;link:&#39;</span><span class="o">+</span><span class="n">short_code</span><span class="o">+</span><span class="s1">&#39;:clicks&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">url</span>
</span><span class='line'>    <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">shortener_domain</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">self</span><span class="o">.</span><span class="n">short_code</span> <span class="k">if</span> <span class="nb">self</span><span class="o">.</span><span class="n">short_code</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_short_code</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">short_code</span> <span class="o">||=</span> <span class="kp">loop</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">token</span> <span class="o">=</span> <span class="p">(</span><span class="vg">$redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s1">&#39;link:next:id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="no">Time</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">36</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span>
</span><span class='line'>      <span class="k">break</span> <span class="n">token</span> <span class="k">unless</span> <span class="no">Link</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">short_code</span><span class="p">:</span> <span class="n">token</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">store_in_redis</span>
</span><span class='line'>    <span class="vg">$redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="no">Link</span><span class="o">.</span><span class="n">redis_url_key</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">short_code</span><span class="p">),</span> <span class="nb">self</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">purchase_link</span><span class="p">)</span>
</span><span class='line'>    <span class="vg">$redis</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="no">Link</span><span class="o">.</span><span class="n">redis_clicks_key</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">short_code</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To start off, we have our validation code to ensure we don&rsquo;t accidently save bad data.</p>

<p>We want to randomly generate a unique short code that is of appropriate length before we save this to the database.  In <code>set_short_code</code>, I keep trying to a valid randomly generated code based off of the time, an incrementor variable I am storing in Redis to ensure uniqueness.  Hypothetically if I got a request at the exact same second and somehow got the same random number, the Redis variable should protect against double urls.</p>

<p>After we write this to the database, we want to store the <code>short_code</code> and <code>long_url</code> in Redis.  We are doing it after we create, because if there are validation errors, then our Redis storage could contain bad data.  The key for the long url will look like &lsquo;link:uDk3nZz:url&rsquo; and the click count will look like &lsquo;link:uDk3nZz:clicks&rsquo;.  So when I want to pull out the long url, I simple say <code>$redis.get(Link.redis_url_key(params[:short_code]))</code> and I will have the long url, assuming it exists.  I can also update the click count in a similar fashion.</p>

<h2>Side note: Redis best practice</h2>

<p>You should use the following naming scheme for all of your Redis keys, so that you have a standard way of retrieving data: [resource]:[id]:[attribute].</p>

<p>I wrote two helper methods to keep track of how we are naming the keys, so we don&rsquo;t end up with a bunch of magic strings everywhere in our project.  If we want to change how we store links in Redis, we only have to look one place, the link model. We will use them later when we create the controller so we know what fields to access with a given <code>short_code</code>.</p>

<h2>Links controller</h2>

<figure class='code'><figcaption><span>links_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">LinksController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="vg">$redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">Link</span><span class="o">.</span><span class="n">redis_url_key</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:short_code</span><span class="o">]</span><span class="p">))</span>
</span><span class='line'>    <span class="k">raise</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">RoutingError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Not Found&#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="n">url</span>
</span><span class='line'>
</span><span class='line'>    <span class="vg">$redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="no">Link</span><span class="o">.</span><span class="n">redis_clicks_key</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:short_code</span><span class="o">]</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">url</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="mi">302</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Use the <code>short_code</code> parameter, and that Redis url key method, we look up the long url.</p>

<p>If we can&rsquo;t find the url, then we rails a 404 page. If not, we continue and bump up the click count.  Redis has a built in incrementor so we wont have to worry about accidently loosing click counts during concurrent requests. and redirect ot the url we found in Redis.</p>

<h2>Configuring Routes to work across multiple domains</h2>

<figure class='code'><figcaption><span>routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">constraints</span> <span class="ss">domain</span><span class="p">:</span> <span class="s2">&quot;example.com&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s2">&quot;/:short_code&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;likes#show&quot;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="s1">&#39;social_share&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We put this the top of our routes.rb file, because we want it to override any of the succeeding route configurations.  I recommend changing your host file to point dev.example.com to 127.0.0.1 so when you test this locally, you would hit your local machine as opposed to the production or staging server.</p>

<h2>To be continue</h2>

<p>In the next article, I will be discussing on how to recover from a Redis failure.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/17/tagging-models/">Tagging Models</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-17T08:14:24-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:14 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/music_slider.jpg" title="Tagging Models" class="banner-img"/></p>

<p>Sometimes you need to tag your models with tokens, think tagging images with keywords or including hashtags in a twitter post.</p>

<p>And in a slightly more rare situation, you sometimes may want to have multiple types of tags for your products.  Like in an ecommerce store, you may want to have a style, color, type, or generic tags attached to your product model.  These tags could be used in an recommendation engine to help determine what products are similar to other products.</p>

<h1>Create the Style Model</h1>

<p>This is your basic many to many relationship between your style model and your products model.</p>

<figure class='code'><figcaption><span>db/migrations/create_styles_table.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="n">create_table</span> <span class="ss">:styles</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:products_styles</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:product_id</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:style_id</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Creating the tags concern</h1>

<p>Because effectively all of the tags are going to have the same attributes (namely <code>:name</code>), I want to have all of that common code in a Concern that will be included in all of the different types of tags</p>

<p>My concern looks like this</p>

<figure class='code'><figcaption><span>app/models/concerns/taggable.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Taggable</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">validate</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">has_and_belongs_to_many</span> <span class="ss">:products</span>
</span><span class='line'>    <span class="n">before_save</span> <span class="ss">:downcase_name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">downcase_name</span>
</span><span class='line'>    <span class="nb">name</span><span class="o">.</span><span class="n">downcase!</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I want to only save the lower case name and I want to automatically report the relationship between products and the taggable attribute.  This will reduce the noise in the database.</p>

<h1>Create the Model</h1>

<p>Now because I am using a concern, my models should be really thin and only look like this</p>

<figure class='code'><figcaption><span>app/models/concerns/taggable.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Style</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Taggable</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Adding and removing tags</h1>

<p>Using the jQuery tokenizer extension, you can follow the guide at <a href="http://railscasts.com/episodes/258-token-fields">Rails casts</a> to hook into your model.  While his approach is dandy and all, we have multiple types of tags attached to our product and there is a faster way to manage the addition methods on our model.</p>

<p>His method requires that you have a method like below for every one of your token attributes.  This is going to make your products model huge as you add more and more taggable attributes.</p>

<figure class='code'><figcaption><span>app/models/concerns/taggable.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_and_belongs_to_many</span> <span class="ss">:authors</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">author_tokens</span><span class="o">=</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">author_ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can reduce this code creep by using Ruby meta programming.  I want to have an array of all of the taggable attributes that product can have and it should automatically create the necessarily methods and relationships between products and this taggable item.</p>

<figure class='code'><figcaption><span>app/models/product.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="no">ATTRIBUTES</span> <span class="o">=</span> <span class="sx">%w(style)</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">ATTRIBUTES</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">status_name</span><span class="o">|</span>
</span><span class='line'>    <span class="n">has_and_belongs_to_many</span> <span class="n">status_name</span><span class="o">.</span><span class="n">pluralize</span><span class="o">.</span><span class="n">to_sym</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">define_method</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">status_name</span><span class="si">}</span><span class="s2">_ids=&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ids</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">send</span> <span class="p">(</span><span class="n">status_name</span><span class="o">.</span><span class="n">pluralize</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">),</span> <span class="n">ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">status_name</span><span class="o">.</span><span class="n">pluralize</span><span class="o">.</span><span class="n">singularize</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now as add more and more taggable items to the product model, it will automatically create the <code>[attribute_name]_ids</code> methods that the jQuery needs to attach these tokens onto our model.  The more taggable attributes I add, the more code I save.</p>

<h1>Alternative approach</h1>

<p>You could argue that I could of put all of the tags in one table and used STI to break each type into different models.  While this could work if all of the tags had the same name type of string, you may want your name attribute to be an integer.  Having them in separate tables will also reduce the table size, thus making the results run a little bit quicker.</p>

<h1>Conclusion</h1>

<p>Like always, feel free to hit me up in the <a href="/chat">chat</a>.  My chat tool is hooked into Google Talk, free too drop me a message if you have any questions.  Cheers.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/16/gem-configuration-defaults/">Gem Configuration Defaults</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-16T19:48:09-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:48 pm</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I have been working on connecting to social media websites via oAuth gems like twitter and koala.  I discovered a neat trick for initializing these gems with environment variables so that you don&rsquo;t have to be passing in the variables every time you want to create a new instance of them.</p>

<p>For this example, I am going to use the twitter gem.  Out of the box, its initializer looks like this taken from their docs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span>        <span class="o">=</span> <span class="s2">&quot;YOUR_CONSUMER_KEY&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span>     <span class="o">=</span> <span class="s2">&quot;YOUR_CONSUMER_SECRET&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token</span>        <span class="o">=</span> <span class="s2">&quot;YOUR_ACCESS_TOKEN&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="s2">&quot;YOUR_ACCESS_SECRET&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is pretty clunky if you ask me, especially if you plan on accessing your users data in a variety of different places in your code.  We can make this more DRY by doing setting the consumer key and consumer secret in an initializer override like this</p>

<figure class='code'><figcaption><span>initializers/twitter.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize_with_default_settings</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:consumer_key</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">fb_app_id</span>
</span><span class='line'>    <span class="n">options</span><span class="o">[</span><span class="ss">:consumer_secret</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">secrets</span><span class="o">.</span><span class="n">fb_secret</span>
</span><span class='line'>    <span class="n">initialize_without_default_settings</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">alias_method_chain</span> <span class="ss">:initialize</span><span class="p">,</span> <span class="ss">:default_settings</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the <a href="http://weblog.rubyonrails.org/2006/4/26/new-in-rails-module-alias_method_chain/">alias_method_chain</a>, we can sneak in some behaviors into the twitter client that weren&rsquo;t originally there, thus allowing us to not need to supply the consumer key every time we want to create a new client.  Now we can do things like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token</span>        <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">access_token</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">access_token_secret</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since the consumer key never changes across calls, this keeps our code that much simpler.
lowing us to not need to supply the consumer key every time we want to create a new client.  Now we can do things like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Twitter</span><span class="o">::</span><span class="no">REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token</span>        <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">access_token</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">access_token_secret</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since the consumer key never changes across calls, this keeps our code that much simpler.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/15/custom-environements-with-rails-4/">Custom Environments With Rails 4</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-05-15T07:41:53-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:41 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you may need to setup custom environments beyond the standard <code>test</code>, <code>development</code>, and <code>production</code> that rails comes with.  If you would like to have your staging server configured a little big differently than test and production (maybe higher logging levels for example), then you would need to create another environment for these configurations called <code>staging</code>.</p>

<h2>Changes, Additions and Edits</h2>

<h3>Gemfile</h3>

<p>In your <code>Gemfile</code>, you should add your new environment to the necessary groups.  If your environment is similar to <code>production</code>, you should add <code>staging</code> next to everywhere you see the <code>production</code> group lie below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:staging</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;log4r&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>Update config/database.yml</h3>

<p>You should create a new environment in your database.yml file.  This will look something like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span> <span class="nl">&amp;default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgresql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">staging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">w2w-staging</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Environment Config</h3>

<p>In <code>config/environments/</code>, you should add <code>staging.rb</code>.  To make things easy, copy an existing environment that is most similar to the new one you are creating and make the adjustments you need from there.</p>

<h3>Update Secrets.yml</h3>

<p>If you are running rails 4.1, you will also need to update your <code>secrets.yml</code> file to handle new the new environment</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">staging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">&lt;&lt;</span><span class="p-Indicator">:</span> <span class="nv">*default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_key_base</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">secrets_are_secretive_SALFJASFLKSAJFLSAFJOWERULSADFJLKSAFJD</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Misc</h3>

<p>Do a quick find on your project directory for any environment specific code being run.  Look for things like <code>Rails.env.</code> and add your new environment to these conditionals like below</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span> <span class="o">||</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="o">||</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">staging?</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/30/nodejs-chat-guide/">NodeJS Chat Guide</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-30T09:40:07-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:40 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>How I built the chat application for my blog.</h2>

<p>I have been chatting on wizpert offering technical support for questions and I was inspired to add a chatting aspect to my blog.  Feel free to hit me up on any Javascript, Ruby on Rails, or general programming questions.</p>

<h2>Installing NodeJS v0.10.26 on OSX Maverick 10.9</h2>

<p>I recommend installing this application with homebrew, so you can easily update it as you need to.</p>

<figure class='code'><figcaption><span>install nodejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">brew update</span>
</span><span class='line'><span class="go">brew doctor</span>
</span><span class='line'><span class="go">brew install node</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a folder called <code>Chat</code> and create a file in that called <code>main.js</code></p>

<figure class='code'><figcaption><span>create a git repo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">git init</span>
</span><span class='line'><span class="go">git add .</span>
</span><span class='line'><span class="go">git commit -m &quot;first!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the NodeJS chat server</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">xmpp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-xmpp&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">cl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span> <span class="nx">jid</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">jid</span><span class="p">,</span>  <span class="nx">password</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">password</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)()</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">admins</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">adminXMPP</span> <span class="o">=</span> <span class="p">[</span> <span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&quot;Welcome to the chat&quot;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="s2">&quot;isAdminOnline&quot;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Admin</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;admin_signin&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;register admin&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">admins</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">users</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]].</span><span class="nx">admin_connected</span> <span class="o">=</span> <span class="nx">socket</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;admin_to_server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">users</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;socket_id&quot;</span><span class="p">]].</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Kevin&quot;</span> <span class="p">});</span>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="s2">&quot;Kevin&quot;</span> <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Client</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message_to_server&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
</span><span class='line'>          <span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">socket</span><span class="o">:</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="nx">admin_connected</span><span class="o">:</span> <span class="kc">null</span> <span class="p">};</span>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">admin_connected</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">stanza</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Element</span><span class="p">(</span>
</span><span class='line'>            <span class="s1">&#39;message&#39;</span><span class="p">,</span>
</span><span class='line'>              <span class="p">{</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;chat&#39;</span> <span class="p">}</span>
</span><span class='line'>          <span class="p">).</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; says &quot;</span> <span class="o">+</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; to talk with them click here: http://ss-chat-p.herokuapp.com/admin#&quot;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">cl</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">stanza</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">users</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">admin_connected</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,{</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;stanza&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stanza</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;presence&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;unavailable&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">adminXMPP</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">adminXMPP</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>            <span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;c.programer@gmail.com&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">adminXMPP</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stanza</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">set_status_message</span><span class="p">(</span><span class="s2">&quot;SparkBot is ready&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Connected as &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">domain</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jid</span><span class="p">.</span><span class="nx">resource</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cl</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">set_status_message</span><span class="p">(</span><span class="nx">status_message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="kd">var</span> <span class="nx">presence_elem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xmpp</span><span class="p">.</span><span class="nx">Element</span><span class="p">(</span><span class="s1">&#39;presence&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">})</span>
</span><span class='line'>                               <span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;chat&#39;</span><span class="p">).</span><span class="nx">up</span><span class="p">()</span>
</span><span class='line'>                               <span class="p">.</span><span class="nx">c</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span><span class="nx">status_message</span><span class="p">);</span>
</span><span class='line'>   <span class="nx">cl</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">presence_elem</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I create all of the singleton variables at the top of the nodejs file. <code>xmpp</code> is used for connecting to Google Talk.  <code>app</code>, <code>server</code>, and <code>io</code> are used to host the server and talk with the client via sockets.io.</p>

<p>I need to keep track of what <code>admins</code> are connected and what <code>users</code> are connected.  While there will only be one admin account, they can be logged into multiple locations.  For users, I need to keep track of their socket and their names to send to the client.  These will both be hash arrays keyed on their <code>socket.id</code>.</p>

<p><code>server.listen(process.env.PORT || 3000);</code> tells the server to listen to the hosting port.  Heroku wants to set its own report, so you must try to environment report before you use the development port (3000).</p>

<p>Once a socket has connected, we send them a welcome message via chat.  This also contains where or not the admin is available to talk.</p>

<p>When an admin connects, we add them to the registered admins list and set the admin socket on the users hash to the admin socket so when a client messages, we will know which admin socket to send it to.  Each socket represents its own chat session with a client.</p>

<p>When the server gets a message from the admin, it runs the <code>admin_to_server</code> event and it transmits the message to the client and back to the admin.  This way both users can see the message.</p>

<p>Clients trigger the <code>message_to_server</code> action when they want to send a chat message to the admin.  If we haven&rsquo;t seen this user before, we add them to the users hash and spit their message back to them.  If the admin hasn&rsquo;t connected yet, it sends a xmpp message to the admin&rsquo;s gmail account notifying them that they someone is interested in talking with them.  The URL in the message contains the user&rsquo;s socket so the server will know what admin socket is intended for what user.</p>

<p>If the admin has connected, then it transmits it to their socket.</p>

<p>We need to keep track of when the admin is available for contact.  When the server starts, it initiates an xmpp connection and starts getting notifications about contact statuses.  If a user changes status or logs in, we add the admin to the <code>adminXMPP</code> so we know who to contact when a client arrives.  If they log out, they are removed from <code>adminXMPP</code>.  If the length of the array is 0, no admins are available and we report that to clients.</p>

<p>The status message is set to &lsquo;SparkBot is ready&rsquo; when the xmpp client connects and it displays their user information in the logs.</p>

<p>If there are any errors with the xmpp client, they are displayed in the logs and the process is killed.</p>

<p>The <code>set_status_method</code> function wraps the xmpp request to set the status message for the Google Talk client.sdfsdf</p>

<h2>Creating the Client view</h2>

<p>This blog is hosted on Github Pages and talks with my server on a different subdomain (chat.kcoleman.me).  I loved the style of Google Talk&rsquo;s chat window with the speech boxes pointing to a profile pic.  Since I don&rsquo;t have a profile pic to use, I replaced that with a name.  You can style this code to your hearts content, but the Javascript I used looks like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>   <span class="kd">var</span> <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;ss-chat-p.herokuapp.com&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;div class=&#39;avatar&#39;&gt;&lt;b&gt;&lt;span&gt;&quot;</span> <span class="o">+</span>
</span><span class='line'>        <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&lt;/b&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&lt;div class=&#39;messages&#39;&gt;&quot;</span><span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;li class=&#39;self&#39;&gt;&quot;</span> <span class="o">+</span>  <span class="nx">msgHTML</span> <span class="o">+</span> <span class="s2">&quot;&lt;/li&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="nx">msgHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;li class=&#39;other&#39;&gt;&quot;</span> <span class="o">+</span>  <span class="nx">msgHTML</span> <span class="o">+</span> <span class="s2">&quot;&lt;/li&gt;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;discussion&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;discussion&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="nx">msgHTML</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#discussion&quot;</span><span class="p">).</span><span class="nx">prop</span><span class="p">({</span> <span class="nx">scrollTop</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#discussion&quot;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s2">&quot;scrollHeight&quot;</span><span class="p">)</span> <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message_to_server&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span> <span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">name</span> <span class="o">:</span> <span class="nx">name</span> <span class="p">});</span>
</span><span class='line'>        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It first tries to connect to the server.  When it receives a message to display, the <code>message_to_client</code> action is triggered.  Here I format the HTML as a string based off of the data payload.  Then it adds into the discussion window.</p>

<p>When a user clicks the submit button, I get the values of the input name and message box and send them to the server as &ldquo;message_to_server&rdquo; and then clear the box for the next message.</p>

<p>Because this uses Sockets.io, we need to include their library in the client as well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://ss-chat-p.herokuapp.com/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Admin View</h2>

<p>This code should look pretty similar to the client, except we need the admin to register right when it connects so we can start sending him the client messages.</p>

<figure class='code'><figcaption><span>admin page</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">socketio</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="s2">&quot;chat.kcoleman.me&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">register</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">target_user</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">socketio</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;message_to_client&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;chatlog&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&lt;hr/&gt;&lt;b&gt;&quot;</span> <span class="o">+</span>
</span><span class='line'>    <span class="nx">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/b&gt;: &quot;</span><span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;chatlog&quot;</span><span class="p">).</span><span class="nx">innerHTML</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">register</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;admin_signin&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">user_id</span><span class="o">:</span> <span class="nx">target_user</span> <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">socketio</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;admin_to_server&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">message</span> <span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">socket_id</span> <span class="o">:</span> <span class="nx">target_user</span><span class="p">});</span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;message_input&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the client connects, it immediately tries to register itself so that the system will know it is available to receive messages.</p>

<h2>In the Future</h2>

<p>I want to be able to retrieve the client&rsquo;s user agent so if there are any browser compatibility errors, I can easily see what browser they have.  If there is a strong need, I may look at implementing a co-browsing solution so I will be able to follow along with them as they navigate my website.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/16/rapid-fire-ticket-purchasing-and-the-extendable-web/">Rapid Ticket Purchasing and the Extendable Web</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-04-16T09:30:31-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:30 am</span></time>
        
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Backstory</h2>

<p>Last month, I was interested in attending a camping event with my girlfriend.  The event organizers release the tickets in two phases with each phase releasing 1000 tickets.  Despite my wicked fast internet connection at Panera Bread, I was unable to purchase the released tickets before they sold out.</p>

<p>In an effort to learn new things, I put my hand towards creating an auto-buy Chrome extension to significantly increase my chances of a ticket purchase.  I also intended to open source the project so anyone would be able to contribute.  Enter <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">rapid_fire_tickets</a>.</p>

<h2>Building the Chrome Extension</h2>

<p>If you get lost, feel free to download the source code for this extension at <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">https://github.com/KevinColemanInc/rapid_fire_tickets</a></p>

<p>Chrome extensions allow you to inject javascript on the page for DOM manipulation.  Firstly, you should create a directory and with our project name as the title.</p>

<p>Now create a <code>manifest.json</code> file.  This file contains all of the high level descriptive information about your project like the name, description, what permissions it wants, what version it is, etc.</p>

<figure class='code'><figcaption><span>manifest.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;manifest_version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Rapid fire tickets for Transformus&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;This extension automatically keeps trying to buy tickets for Transformus.&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&quot;content_scripts&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://www.brownpapertickets.com/event/614931*&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;js&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;jquery.js&quot;</span><span class="p">,</span> <span class="s2">&quot;home.js&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;run_at&quot;</span><span class="p">:</span> <span class="s2">&quot;document_start&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://www.brownpapertickets.com/viewcart.html&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;js&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;jquery.js&quot;</span><span class="p">,</span> <span class="s2">&quot;checkout.js&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;run_at&quot;</span><span class="p">:</span> <span class="s2">&quot;document_end&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first part is very self explanatory, but the <code>content_scripts</code> attribute is much more interesting.  Here you can request Chrome to run javascript files if the URL pattern matches the string provided.  Since I know that the ticketing websiteâ€™s URL is such, I included that in the matches string.  The asterisk at the end of the string protects me against any strange URL parameters that might present themselves.</p>

<p>The <code>js</code> attribute tells Chrome to run the included js files when that URL is hit.  I included <code>jQuery</code> in this extension so make life easier.  Then I put my custom js file that will be used to refresh the page and select tickets.</p>

<p>The <code>run_at</code> attribute requests that chrome run the JS at document start.  I did this because I wanted the JS to run before all of the attributes to load so it will behave faster.</p>

<p>Next I will go download <code>jQuery</code> and save it into this folder.  Be sure to name the file the same as how you named it the manifest file.</p>

<p>Next I will create my home.js file.  The idea here is to have it refresh the page until the we see the drop down for ticket selection.  Once that appears we need to set that to a value of 2 and click the submit button on the form.</p>

<h2>Testing</h2>

<p>From that link, we have no idea what the HTML looks and thus donâ€™t know how to sculpt the jQuery selectors to target the correct form elements.  I created a test event and modeled it to behave exactly like the tfus event will when the tickets are released.  This way I can test my software before aiming it at the first event.</p>

<h2>Refresh and check to see if tickets are available</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="c1">//buy tickets</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span> <span class="c1">//reload</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>On my test page I noticed that the orange submit button appears on the page when tickets are available.  For this tool, I am going to look for all orange buttons on the page.  If one appears, then tickets are ready to be purchased.  If they are not, then we need to reload the page to check again.</p>

<h2>Select the number of tickets you want</h2>

<p>Now that I can detect when the tickets are available.  I am need to select the drop down and select the number of tickets.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bpt_date_prices_1017125 .bpt_widget_price_table tr:nth-child(4) select&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using Chrome development tools, I found that this selector worked nicely at accomplishing that.  The id of the first element changes event to event, so if I wish to use this against other events, this will need to change.</p>

<p>Putting it all together we get this:</p>

<figure class='code'><figcaption><span>home.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span> <span class="nb">document</span> <span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#bpt_date_prices_1017125 .bpt_widget_price_table tr:nth-child(4) select&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.bpt_orangebutton&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>A super simple auto add to cart ticket file.</p>

<h2>One step further</h2>

<p>After the tickets have been added to cart, it displays a page asking if you would like to check out now.  Under most circumstances, this scenario is yes.  To speed up the ticket purchasing process, I added another script to auto-click this button.  We can just skip that page and go to directly to the credit card input page.</p>

<p>The script that handles this is similar to the last one and looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">parent</span><span class="p">.</span><span class="nx">location</span><span class="o">=</span><span class="s1">&#39;https://www.brownpapertickets.com/checkout.html&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rather than locating that button and click it.  I recognized that button is just a link to the checkout page so I ask the browser to relocate to this page.  If there are an cosmetic changes to this page and they change how the page is displayed, it may break any selectors I use on finding that button.  This solution is much more elegant and simple.</p>

<h2>Installation</h2>

<ol>
<li>In Chrome to <a href="chrome://extensions/">chrome://extensions/</a> and click &ldquo;Load unpacked extensions&rdquo;</li>
<li>Navigate to the location of the folder you created with the manifest.</li>
<li>Sign into your <a href="http://www.brownpapertickets.com">http://www.brownpapertickets.com</a> account</li>
<li>Open a bunch of tabs in chrome and navigate them all to: <a href="http://www.brownpapertickets.com/event/614931">http://www.brownpapertickets.com/event/614931</a></li>
</ol>


<h3>Alternative installation (using my source code on <a href="https://github.com/KevinColemanInc/rapid_fire_tickets">github</a>).</h3>

<ol>
<li>Download the <a href="https://github.com/KevinColemanInc/rapid_fire_tickets/archive/master.zip">zip file</a></li>
<li>Unzip it</li>
<li>In Chrome to <a href="chrome://extensions/">chrome://extensions/</a> and click &ldquo;Load unpacked extensions&rdquo;</li>
<li>Navigate to the unziped location of the file.</li>
<li>Sign into your <a href="http://www.brownpapertickets.com">http://www.brownpapertickets.com</a> account</li>
<li>Open a bunch of tabs in chrome and navigate them all to: <a href="http://www.brownpapertickets.com/event/614931">http://www.brownpapertickets.com/event/614931</a></li>
</ol>


<h2>Buying more than two tickets</h2>

<p>This extension will only purchase two tickets per installation of Chrome.  If you are interested in using this to accumulate more, then here are my recommendations.</p>

<p>In <a href="chrome://extensions/">chrome://extensions/</a>, scroll down to the rapid_fire_tickets and select &ldquo;Allow in incognito mode.&rdquo;  Incognito mode allows you to login to Brown Paper Tickets from another account (thus giving you an additional 2 more tickets).</p>

<p>Now press <code>Ctrl+Shift+N</code> to open a new incognito window, login to a different account and navigate to the event page.  Now you buy 4 tickets!</p>

<p>Next, we should install a couple copies of Chrome.  Chrome only allows one version to be installed on a computer at a given time.  So lets grab other builds!  Go to <a href="http://www.chromium.org/getting-involved/dev-channel">http://www.chromium.org/getting-involved/dev-channel</a> and download and install their canary release.  This version runs seperately from what you have on your computer, because it can be less stable.</p>

<p>Configure the extension like you did before and now you have 8 tickets you can purchase!  Remember, only two tickets can be purchased at once per account so be sure to use different accounts.</p>

<h3>Quick tip: One gmail for multiple accounts</h3>

<p>If you use gmail, you can use their wild card feature to have different emails that point to your email.  For example my email is <a href="&#x6d;&#97;&#x69;&#x6c;&#x74;&#111;&#58;&#99;&#x2e;&#112;&#x72;&#111;&#x67;&#x72;&#x61;&#109;&#101;&#114;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;&#46;">&#99;&#46;&#x70;&#114;&#x6f;&#103;&#x72;&#97;&#x6d;&#101;&#x72;&#x40;&#x67;&#109;&#97;&#105;&#x6c;&#x2e;&#99;&#x6f;&#x6d;&#46;</a>  I can create a different brown paper tickets account with this email <a href="&#109;&#x61;&#105;&#x6c;&#x74;&#111;&#x3a;&#99;&#x2e;&#x70;&#x72;&#111;&#x67;&#114;&#x61;&#109;&#101;&#114;&#43;&#98;&#x70;&#x74;&#64;&#x67;&#x6d;&#x61;&#105;&#108;&#46;&#x63;&#111;&#109;">&#x63;&#46;&#112;&#114;&#x6f;&#x67;&#114;&#97;&#109;&#x65;&#114;&#x2b;&#98;&#x70;&#x74;&#64;&#x67;&#109;&#97;&#105;&#x6c;&#46;&#99;&#x6f;&#x6d;</a> and all of the emails going to that new email go to my main inbox.  This way I don&rsquo;t have to keep creating emails to make new accounts.  Anything between the + and the @ symbols are ignored in gmail only.</p>

<h3>Lets scale this further (8 to infinite and beyond!)</h3>

<p>We can apply this technique to multiple computers.  Each computer earns you 8 tickets. So if you are like myself that has a laptop and a desktop and a gf&rsquo;s computer, then I would have the opportunity to purchase 24 tickets!  This scales at 8 tickets per computer.  So 10 computers allows you to purchase 80 tickets (or 8% of all tickets avaliable!).</p>

<p>For those with more resources, you can go to a public library or a college&rsquo;s computer lab to install an apply this extension to an even larger number of computers.</p>

<h2>Conclusion</h2>

<p>Feel free to hack and fork this tool as much as you would like.  I really hope that everyone enjoyed reading this as much I as I enjoyed writing it. Best of luck to everyone buying tickets this weekend!</p>

<h2>Notes</h2>

<p>I would be careful about opening too many tabs, because they may actually slow down the process.  In experimentation, I was able to grab 2 tickets to an event I created with 12 tabs within 10 seconds of the release.</p>

<p>This currently attempts to grab the maximum amount of tickets (2).</p>

<h1>PLEASE PLEASE PLEASE check back with the project an hour before tickets become avaliable.  I plan on releasing an updated version of the project to handle any issues that may arise.</h1>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Kevin Coleman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  








  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
